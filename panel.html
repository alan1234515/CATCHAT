<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Usuario</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<style>
body { font-family: 'Segoe UI', sans-serif; margin:0; background:#f3f4f6; }
.bubble { display: inline-block; padding: 8px 12px; border-radius: 16px; max-width: 70%; word-wrap: break-word; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; transition: all 0.2s ease-in-out; }
.bubble-left { background-color: #f3f4f6; color: #111827; align-self: flex-start; }
.bubble-right { background-color: #3b82f6; color: white; align-self: flex-end; }
.chat-header { font-weight: bold; padding: 12px; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; gap: 8px; background-color: #2563eb; color: white; font-size: 1rem; }
.chat-img { cursor: pointer; max-width: 180px; max-height: 180px; border-radius: 12px; transition: transform 0.2s ease; }
.chat-img:hover { transform: scale(1.05); }
.overlay { position: fixed; display: none; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 50; }
.overlay img { max-width: 90%; max-height: 90%; border-radius: 12px; }
.msg-input { display: flex; gap: 8px; padding: 8px; border-top: 1px solid #ddd; background: #f9fafb; align-items: center; }
.msg-input input[type="text"] { flex: 1; padding: 8px 12px; border-radius: 999px; border: 1px solid #d1d5db; outline: none; }
.msg-input button { background: #3b82f6; color: white; padding: 8px 12px; border-radius: 999px; display: flex; align-items: center; justify-content: center; }
.msg-input button:hover { background: #2563eb; }
.user-icon { width: 30px; height: 30px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
.chat-list-item { cursor: pointer; padding: 8px; border-radius: 8px; display: flex; align-items: center; gap: 8px; position: relative; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-list-item:hover { background-color: #e5e7eb; }
.unread-dot { width: 10px; height: 10px; background: red; border-radius: 50%; }
.scrollbar { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #888 #f3f4f6; }
.scrollbar::-webkit-scrollbar { width: 6px; }
.scrollbar::-webkit-scrollbar-thumb { background-color: #888; border-radius: 3px; }
#panel-chat { flex: 1; display: flex; width: 100%; max-width: 1200px; height: calc(100vh - 80px); background:white; border-radius:12px; overflow:hidden; }
@media (max-width: 768px){
  #panel-chat { flex-direction: column; height: auto; }
  #panel-chat > div { width: 100% !important; }
  .bubble { max-width: 90%; }
  .chat-header { font-size: 0.9rem; justify-content: space-between; }
  .chat-img { max-width: 120px; max-height: 120px; }
  .msg-input { flex-wrap: wrap; gap: 4px; }
  .msg-input input[type="text"] { flex: 1 1 100%; }
  .msg-input button { flex: 1 1 auto; padding: 6px 8px; }
}
</style>
</head>
<body class="flex flex-col items-center justify-start p-2">

<!-- Header -->
<div class="container bg-white p-4 rounded-xl shadow-md w-full max-w-md mb-4 flex justify-between items-center">
  <h2 class="text-2xl font-bold">Bienvenido, <span id="nombreUsuario"></span></h2>
  <button id="cerrarSesion" class="text-red-500 hover:text-red-700"><i data-feather="log-out"></i></button>
</div>

<!-- Chat panel -->
<div id="panel-chat" class="hidden">
  <div class="w-1/3 border-r p-2 flex flex-col gap-4">
    <div>
      <h3 class="font-semibold mb-2">Enviar solicitud</h3>
      <input id="correoSolicitud" type="email" placeholder="Correo del usuario" class="w-full p-2 border rounded mb-2" />
      <button id="enviarSolicitudBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 transition flex items-center gap-2">
        <i data-feather="send"></i> Enviar
      </button>
      <div id="msgSolicitud" class="mt-2"></div>
    </div>
    <h3 class="font-semibold mt-2 mb-2">Solicitudes</h3>
    <div id="solicitudes" class="flex flex-col gap-2 scrollbar max-h-40"></div>
    <h3 class="font-semibold mt-4 mb-2">Chats</h3>
    <div id="chats" class="flex flex-col gap-2 scrollbar flex-1">
      <div id="loaderChats" class="text-gray-500 text-center mt-4">Cargando chats...</div>
    </div>
  </div>

  <div class="w-2/3 flex flex-col">
    <div id="chatHeader" class="chat-header">Selecciona un chat</div>
    <div id="mensajes" class="flex-1 overflow-y-auto p-2 flex flex-col gap-2 scrollbar"></div>
    <div class="msg-input">
      <button id="btnArchivo"><i data-feather="paperclip"></i></button>
      <input id="archivoMensaje" type="file" class="hidden" />
      <input id="nuevoMensaje" type="text" placeholder="Escribe tu mensaje..." />
      <button id="enviarMensaje"><i data-feather="send"></i></button>
    </div>
  </div>
</div>

<!-- Overlay imagen -->
<div id="overlay" class="overlay flex" onclick="this.style.display='none'">
  <img id="overlayImg" src="" />
</div>

<script>
feather.replace();
const API = "https://catchat12.onrender.com";
const nombreUsuario=document.getElementById("nombreUsuario");
const email=localStorage.getItem("usuarioEmail");
const cerrar=document.getElementById("cerrarSesion");
let chatActivoId=null;

if(!email) window.location.href="login.html";

// Cerrar sesiÃ³n
cerrar.addEventListener("click", ()=>{ localStorage.removeItem("usuarioEmail"); window.location.href="login.html"; });

// Cargar usuario y panel
async function obtenerUsuario(){
  try{
    const res = await fetch(`${API}/usuario?email=${email}`);
    const data = await res.json();
    if(data.error) return window.location.href="login.html";
    nombreUsuario.textContent = data.nombre;
    cargarPanel();
  }catch(err){ console.error(err); }
}

// Panel principal
async function cargarPanel(){
  document.getElementById("panel-chat").classList.remove("hidden");
  await cargarSolicitudes();
  await cargarChats();
  setInterval(async ()=>{
    if(chatActivoId) await cargarMensajes(chatActivoId);
    await cargarChats();
  },5000);
}

// Solicitudes
async function cargarSolicitudes(){
  try{
    const res=await fetch(`${API}/solicitudes?email=${email}`);
    const solicitudes=await res.json();
    const container=document.getElementById("solicitudes");
    container.innerHTML="";
    solicitudes.forEach(s=>{
      const div=document.createElement("div");
      div.className="flex justify-between items-center bg-gray-100 p-2 rounded shadow-sm";
      div.textContent=`${s.nombre} (${s.email})`;
      const aceptar=document.createElement("button");
      aceptar.textContent="Aceptar";
      aceptar.className="ml-2 bg-green-500 text-white px-2 rounded hover:bg-green-600";
      aceptar.onclick=async ()=>{
        await fetch(`${API}/solicitud/aceptar`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({solicitudId:s.id})});
        cargarSolicitudes(); cargarChats();
      };
      div.appendChild(aceptar);
      container.appendChild(div);
    });
  }catch(err){ console.error(err); }
}

// Chats
async function cargarChats(){
  const loader = document.getElementById("loaderChats");
  loader.style.display = "block";
  try{
    const res = await fetch(`${API}/chats?email=${email}`);
    const chats = await res.json();
    const container = document.getElementById("chats");
    container.innerHTML = "";
    if(!chats || chats.length===0){
      container.innerHTML = "<div class='text-gray-500 text-center mt-4'>No hay chats disponibles</div>";
      return;
    }
    for(const c of chats){
      const div = document.createElement("div");
      div.className = "chat-list-item relative";
      const ultimo = c.ultimoMensaje ? (c.ultimoMensaje.length>30?c.ultimoMensaje.slice(0,30)+'...':c.ultimoMensaje) : "";
      let horaUltimo = "";
      if(c.fechaUltimoMensaje){
        const fechaUTC = new Date(c.fechaUltimoMensaje);
        const fechaEcuador = new Date(fechaUTC.getTime() - 5*60*60*1000);
        horaUltimo = `<span class="text-gray-400 text-xs ml-1">${fechaEcuador.getHours().toString().padStart(2,'0')}:${fechaEcuador.getMinutes().toString().padStart(2,'0')}</span>`;
      }
      div.innerHTML = `<div class="user-icon">${c.nombre.charAt(0)}</div>
                       <div class="flex flex-col">
                         <span>${c.nombre}${horaUltimo}</span>
                         <span class="text-gray-500 text-sm">${ultimo}</span>
                       </div>`;
      if(c.cantidadNoLeidos>0 && chatActivoId!==c.id){
        const punto = document.createElement("span");
        punto.className="unread-dot absolute right-2 top-2 text-white text-xs flex items-center justify-center";
        punto.style.width="18px"; punto.style.height="18px"; punto.style.background="red"; punto.style.borderRadius="50%";
        punto.textContent=c.cantidadNoLeidos;
        div.appendChild(punto);
      }
      div.onclick = () => { chatActivoId=c.id; document.getElementById("chatHeader").textContent=c.nombre; cargarMensajes(chatActivoId,true); };
      container.appendChild(div);
    }
  }catch(err){ console.error(err); }
  finally{ loader.style.display="none"; }
}

// Mensajes
async function cargarMensajes(chatId, forzarScroll=false){
  const container = document.getElementById("mensajes");
  const estabaAlFinal = container.scrollHeight - container.scrollTop <= container.clientHeight + 5;
  try{
    const res = await fetch(`${API}/mensajes?chatId=${chatId}`);
    const mensajes = await res.json();
    container.innerHTML = "";
    const urlRegex = /(https?:\/\/\S+\.(?:jpg|jpeg|png|gif))/i;

    mensajes.forEach(m=>{
      const div = document.createElement("div");
      div.className = m.email===email ? "bubble bubble-right" : "bubble bubble-left";
      let horaMensaje="";
      if(m.fecha){ const fechaUTC=new Date(m.fecha); const fechaEcuador=new Date(fechaUTC.getTime() - 5*60*60*1000); horaMensaje=`<span style="font-size:0.7rem;color:#666;margin-left:4px;">${fechaEcuador.getHours().toString().padStart(2,'0')}:${fechaEcuador.getMinutes().toString().padStart(2,'0')}</span>`; }

      let mensajeRenderizado = m.mensaje||"";
      const match = mensajeRenderizado.match(urlRegex);
      if(match){
        div.innerHTML = `<strong>${m.nombre}:</strong><br>
                         <img src="${match[0]}" class="chat-img" onclick="document.getElementById('overlayImg').src='${match[0]}';document.getElementById('overlay').style.display='flex';">
                         ${mensajeRenderizado.replace(match[0],'')} ${horaMensaje}`;
      } else if(m.archivo){
        div.innerHTML = `<strong>${m.nombre}:</strong> <a href="${m.archivo}" target="_blank" class="text-blue-600 underline">ð Ver archivo</a>${m.mensaje?'<br>'+m.mensaje:''}${horaMensaje}`;
      } else{
        div.innerHTML = `<strong>${m.nombre}:</strong> ${mensajeRenderizado}${horaMensaje}`;
      }

      if(m.email===email){ const tick=document.createElement("span"); tick.style.marginLeft="6px"; tick.style.fontSize="0.8rem"; tick.textContent=m.visto?"ââ":"â"; div.appendChild(tick); }
      container.appendChild(div);
    });
    if(estabaAlFinal || forzarScroll) container.scrollTop = container.scrollHeight;
  }catch(err){ console.error(err); }
}

// Enviar mensaje
document.getElementById("enviarMensaje").addEventListener("click", async ()=>{
  const texto=document.getElementById("nuevoMensaje").value.trim();
  const archivoInput=document.getElementById("archivoMensaje");
  if(!texto && !archivoInput.files.length) return;
  if(!chatActivoId) return;
  const formData=new FormData();
  formData.append("chatId",chatActivoId);
  formData.append("deEmail",email);
  formData.append("mensaje",texto);
  if(archivoInput.files.length) formData.append("archivo",archivoInput.files[0]);
  try{
    await fetch(`${API}/mensajeArchivo`,{method:"POST",body:formData});
    document.getElementById("nuevoMensaje").value="";
    archivoInput.value="";
    cargarMensajes(chatActivoId,true);
  }catch(err){ console.error(err); }
});

// Enter para enviar
document.getElementById("nuevoMensaje").addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); document.getElementById("enviarMensaje").click(); }});

// Archivo
document.getElementById("archivoMensaje").addEventListener("change", ()=>{ const archivo=document.getElementById("archivoMensaje").files[0]; document.getElementById("nuevoMensaje").value=archivo?`Archivo: ${archivo.name}`:""; });
document.getElementById("btnArchivo").addEventListener("click",()=>{document.getElementById("archivoMensaje").click();});

// Enviar solicitud
document.getElementById("enviarSolicitudBtn").addEventListener("click", async ()=>{
  const correoDestino=document.getElementById("correoSolicitud").value.trim();
  const msgDiv=document.getElementById("msgSolicitud");
  if(!correoDestino){ msgDiv.textContent="Ingresa un correo vÃ¡lido"; msgDiv.className="text-red-600"; return; }
  try{
    const res=await fetch(`${API}/solicitud`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deEmail:email,aEmail:correoDestino})});
    const data=await res.json();
    msgDiv.textContent=data.message||data.error;
    msgDiv.className=data.message?"text-green-600":"text-red-600";
    if(data.message){ document.getElementById("correoSolicitud").value=""; cargarSolicitudes(); }
  }catch(err){ console.error(err); msgDiv.textContent="Error de conexiÃ³n"; msgDiv.className="text-red-600"; }
});

// Inicializar
obtenerUsuario();
</script>
</body>
</html>
