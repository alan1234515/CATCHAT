<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catchat - Panel de Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
  body { font-family: 'Segoe UI', sans-serif; }
  .bubble { max-width: 80%; word-wrap: break-word; position: relative; transition: all 0.2s ease-in-out; }
  .bubble-left { background-color: #f3f4f6; color: #111827; align-self: flex-start; padding: 0.5rem 0.75rem; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
  .bubble-right { background-color: #3b82f6; color: white; align-self: flex-end; padding: 0.5rem 0.75rem; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
  .chat-img:hover { transform: scale(1.05); cursor:pointer; }
  .scrollbar { overflow-y:auto; scrollbar-width:thin; scrollbar-color:#888 #f3f4f6; }
  .scrollbar::-webkit-scrollbar { width:6px; }
  .scrollbar::-webkit-scrollbar-thumb { background-color:#888; }
  #mensajes { flex:1 1 0; min-height:0; overflow-y:auto; display:flex; flex-direction:column; gap:0.25rem; }
  .unread-dot { font-size:0.75rem; }
  @media (max-width:768px){
    #panel-chat { flex-direction:column; height: calc(100vh - 50px); }
    #panel-chat > div { width:100% !important; }
    #mensajes { max-height:60%; }
    .bubble { max-width:90%; }
    .chat-img { max-width:120px; max-height:120px; }
  }
</style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

<!-- Panel de chat -->
<div id="panel-chat" class="flex w-full max-w-6xl h-[600px] border rounded shadow-md overflow-hidden">
  <div class="w-1/3 border-r p-2 flex flex-col gap-4">
    <h3 class="font-semibold mb-2">Chats</h3>
    <div id="chats" class="flex flex-col gap-2 scrollbar flex-1"></div>
  </div>
  <div class="w-2/3 flex flex-col">
    <div id="chatHeader" class="chat-header font-bold p-3 border-b bg-blue-600 text-white flex items-center gap-2">Selecciona un chat</div>
    <div id="mensajes" class="flex-1 overflow-y-auto flex flex-col gap-1 scrollbar"></div>
    <div class="msg-input flex gap-2 p-2 border-t bg-gray-100 items-center">
      <button id="btnArchivo"><i data-feather="paperclip"></i></button>
      <input id="archivoMensaje" type="file" class="hidden" />
      <input id="nuevoMensaje" type="text" placeholder="Escribe tu mensaje..." class="flex-1 p-2 border rounded-full"/>
      <button id="enviarMensaje"><i data-feather="send"></i></button>
    </div>
  </div>
</div>

<div id="overlay" class="overlay flex hidden fixed top-0 left-0 right-0 bottom-0 bg-black/70 justify-center items-center z-50" onclick="this.style.display='none'">
  <img id="overlayImg" src="" class="max-w-[90%] max-h-[90%] rounded-xl" />
</div>

<script>
feather.replace();
const API = "https://catchat12.onrender.com";
const socket = io(API);
const email = localStorage.getItem("usuarioEmail") || "usuarioPrueba@example.com";
let chatActivoId = null;
let ultimoMensajeId = 0;

// Fetch helper
async function apiFetch(endpoint, options={}) {
  try { const res = await fetch(`${API}${endpoint}`, options); return await res.json(); }
  catch(err){ console.error("API error:", err); return { error: "Error de conexiÃ³n" }; }
}

// Cargar chats
async function cargarChats(){
  const chats = await apiFetch(`/chats?email=${email}`);
  const container = document.getElementById("chats"); container.innerHTML="";
  if(!chats || chats.length===0){ container.innerHTML="<div class='text-gray-500 text-center mt-4'>No hay chats</div>"; return; }
  chats.forEach(c=>{
    const div = document.createElement("div");
    div.className="chat-list-item p-2 border rounded cursor-pointer"; div.dataset.id=c.id;
    const ultimo = c.ultimoMensaje ? (c.ultimoMensaje.slice(0,30)+(c.ultimoMensaje.length>30?"...":"")) : "";
    div.innerHTML=`<strong>${c.nombre}</strong><br><span class="text-gray-500 text-sm">${ultimo}</span>`;
    div.onclick = ()=>{ chatActivoId=c.id; document.getElementById("chatHeader").textContent=c.nombre; cargarMensajes(chatActivoId,true); };
    container.appendChild(div);
  });
}

// Cargar mensajes
async function cargarMensajes(chatId, limpiar=false){
  const container=document.getElementById("mensajes");
  if(limpiar) container.innerHTML="";
  const mensajes = await apiFetch(`/mensajes?chatId=${chatId}&desde=${ultimoMensajeId}`);
  if(!mensajes) return;
  mensajes.forEach(m=> renderMensaje(m));
  container.scrollTop = container.scrollHeight;
}

// Renderizar mensaje
function renderMensaje(m){
  const container=document.getElementById("mensajes");
  const div=document.createElement("div");
  div.className = m.email===email?"bubble bubble-right":"bubble bubble-left";
  let hora="";
  if(m.fecha){ const f=new Date(m.fecha); hora=`<span style="font-size:0.7rem;color:#666;margin-left:4px">${f.getHours().toString().padStart(2,'0')}:${f.getMinutes().toString().padStart(2,'0')}</span>`; }

  if(m.archivo && m.archivo.match(/\.(jpg|jpeg|png|gif)$/i)){
    div.innerHTML=`<strong>${m.nombre}:</strong><br><img src="${m.archivo}" class="chat-img" onclick="document.getElementById('overlayImg').src='${m.archivo}';document.getElementById('overlay').style.display='flex'">${m.mensaje?'<br>'+m.mensaje:''}${hora}`;
  } else if(m.archivo){
    div.innerHTML=`<strong>${m.nombre}:</strong> <a href="${m.archivo}" target="_blank" class="text-blue-600 underline">ðŸ“Ž Ver archivo</a>${m.mensaje?'<br>'+m.mensaje:''}${hora}`;
  } else {
    div.innerHTML=`<strong>${m.nombre}:</strong> ${m.mensaje||""}${hora}`;
  }

  if(m.email===email){
    const tick=document.createElement("span"); tick.style.marginLeft="6px"; tick.style.fontSize="0.8rem"; tick.textContent=m.visto?"âœ”âœ”":"âœ”";
    div.appendChild(tick);
  }

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  ultimoMensajeId = Math.max(ultimoMensajeId, m.id);
}

// Enviar mensaje
document.getElementById("enviarMensaje").addEventListener("click", async ()=>{
  const texto = document.getElementById("nuevoMensaje").value.trim();
  const archivoInput = document.getElementById("archivoMensaje");
  if(!chatActivoId || (!texto && !archivoInput.files.length)) return;

  const formData = new FormData();
  formData.append("chatId", chatActivoId);
  formData.append("deEmail", email);
  formData.append("mensaje", texto);
  if(archivoInput.files.length) formData.append("archivo", archivoInput.files[0]);

  const btn = document.getElementById("enviarMensaje");
  btn.disabled = true;

  const data = await fetch(`${API}/mensajeArchivo`, {method:"POST", body: formData}).then(res=>res.json());
  document.getElementById("nuevoMensaje").value=""; archivoInput.value="";
  renderMensaje(data.mensaje); // se agrega inmediato
  socket.emit("nuevoMensaje", data.mensaje);
  btn.disabled = false;
});

// Socket.io para mensajes en tiempo real
socket.on("nuevoMensaje", (msg) => { if(chatActivoId===msg.chatId) renderMensaje(msg); });
socket.on("mensajeVisto", ({mensajeId})=>{ document.querySelectorAll(".bubble-right span").forEach(t=>{ t.textContent="âœ”âœ”"; }); });

// Inicializar
cargarChats();
</script>
</body>
</html>
